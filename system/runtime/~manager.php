<?php
 class Manager { public $_POST_DATA = array(); public $_FILES_DATA = array(); protected function render_template($template, array $template_vars = NULL) { $orig_template = strtolower($template); if (strpos($template, '/')) { $template = strtr(pathinfo($orig_template, PATHINFO_DIRNAME), '/', DS).DS.substr(strrchr($orig_template, '/'), 1); } $template_file_path = APP_TEMPLATE_DIR.$template.'.php'; if ( ! file_exists($template_file_path)) { halt('A System Error Was Encountered', "Unknown template file '{$orig_template}'", 'sys_error'); } else { if (count($template_vars) > 0) { extract($template_vars, EXTR_OVERWRITE); } ob_start(); require $template_file_path; $content = ob_get_contents(); ob_end_clean(); return $content; } } protected function response(array $config = NULL) { if (isset($config['content']) && isset($config['type'])) { $headers = array(); $mime_types = array( 'text/html', 'text/plain', 'text/css', 'text/javascript', 'application/xml', 'application/json', ); $headers['Content-Type'] = in_array($config['type'], $mime_types) ? $config['type'].'; charset=utf-8' : $config['type']; if (isset($config['disable_cache']) && $config['disable_cache'] === TRUE) { $headers['Expires'] = 'Mon, 26 Jul 1997 05:00:00 GMT'; $headers['Last-Modified'] = gmdate("D, d M Y H:i:s") . " GMT"; $headers['Cache-Control'] = 'no-store, no-cache, must-revalidate, post-check=0, pre-check=0'; $headers['Pragma'] = 'no-cache'; } if (isset($config['extra_headers']) && is_array($config['extra_headers'])) { $headers = array_merge($headers, $config['extra_headers']); } foreach ($headers as $name => $val) { header($name.': '.$val); } echo $config['content']; } } protected function load_data($data, $alias = '') { $data = strtolower($data); $orig_data = $data; if (strpos($data, '/') === FALSE) { $path = ''; } else { $path = strtr(pathinfo($data, PATHINFO_DIRNAME), '/', DS).DS; $data = substr(strrchr($data, '/'), 1); } if ($alias === '') { $alias = $data; } if (method_exists($this, $alias)) { halt('A System Error Was Encountered', "Data name '{$alias}' is an invalid (reserved) name", 'sys_error'); } if ( ! isset($this->$alias)) { $source_file = APP_DATA_DIR.$path.$data.'.php'; if ( ! file_exists($source_file)) { halt('A System Error Was Encountered', "Unknown data file name '{$orig_data}'", 'sys_error'); } if (RUNTIME_CACHE === TRUE) { $temp_cache_name = str_replace(DS, '_', $path.$data); $file = APP_RUNTIME_CACHE_DIR.'~'.$temp_cache_name.'.php'; if ( ! file_exists($file)) { file_put_contents($file, php_strip_whitespace($source_file)); } } else { $file = $source_file; } require_once $file; if ( ! class_exists($data)) { halt('A System Error Was Encountered', "Unknown class name '{$data}'", 'sys_error'); } $this->{$alias} = new $data; } } protected function load_library($scope, $library, $alias = '', array $config = NULL) { $library = strtolower($library); $orig_library = $library; if (strpos($library, '/') === FALSE) { $path = ''; } else { $path = strtr(pathinfo($library, PATHINFO_DIRNAME), '/', DS).DS; $library = substr(strrchr($library, '/'), 1); } if ($alias === '') { $alias = $library; } if (method_exists($this, $alias)) { halt('A System Error Was Encountered', "Library name '{$alias}' is an invalid (reserved) name", 'sys_error'); } if ( ! isset($this->$alias)) { if ($scope === 'SYS') { $source_file = SYS_LIBRARY_DIR.$path.$library.'.php'; } elseif ($scope === 'APP') { $source_file = APP_LIBRARY_DIR.$path.$library.'.php'; } else { halt('A System Error Was Encountered', "The location of the library must be specified, either 'SYS' or 'APP'", 'sys_error'); } if ( ! file_exists($source_file)) { halt('A System Error Was Encountered', "Unknown library file name '{$orig_library}'", 'sys_error'); } if (RUNTIME_CACHE === TRUE) { $temp_cache_name = str_replace(DS, '_', $path.$library); if ($scope === 'SYS') { $file = SYS_RUNTIME_CACHE_DIR.'~'.$temp_cache_name.'.php'; } elseif ($scope === 'APP') { $file = APP_RUNTIME_CACHE_DIR.'~'.$temp_cache_name.'.php'; } if ( ! file_exists($file)) { file_put_contents($file, php_strip_whitespace($source_file)); } } else { $file = $source_file; } require_once $file; if ( ! class_exists($library)) { halt('A System Error Was Encountered', "Unknown class name '{$library}'", 'sys_error'); } $this->{$alias} = new $library($config); } } protected function load_function($scope, $func) { $orig_func = strtolower($func); if (strpos($func, '/') === FALSE) { $path = ''; } else { $path = strtr(pathinfo($func, PATHINFO_DIRNAME), '/', DS).DS; $func = substr(strrchr($func, '/'), 1); } if ($scope === 'SYS') { $source_file = SYS_FUNCTION_DIR.$path.$func.'.php'; } elseif ($scope === 'APP') { $source_file = APP_FUNCTION_DIR.$path.$func.'.php'; } else { halt('A System Error Was Encountered', "The location of the functions folder must be specified, either 'SYS' or 'APP'", 'sys_error'); } if ( ! file_exists($source_file)) { halt('An Error Was Encountered', "Unknown function script '{$orig_func}'", 'sys_error'); } if (RUNTIME_CACHE === TRUE) { $temp_cache_name = str_replace(DS, '_', $path.$func); if ($scope === 'SYS') { $file = SYS_RUNTIME_CACHE_DIR.'~'.$temp_cache_name.'.php'; } elseif ($scope === 'APP') { $file = APP_RUNTIME_CACHE_DIR.'~'.$temp_cache_name.'.php'; } if ( ! file_exists($file)) { file_put_contents($file, php_strip_whitespace($source_file)); } } else { $file = $source_file; } require_once $file; } } 